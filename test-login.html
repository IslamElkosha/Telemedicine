<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Test - Supabase Auth</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #0052a3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .test-accounts {
      margin-top: 20px;
      padding: 15px;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
    }
    .test-accounts h3 {
      margin-top: 0;
      color: #856404;
    }
    .test-accounts ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .test-accounts li {
      margin: 5px 0;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Supabase Login Test</h1>

    <form id="loginForm">
      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" required value="patient@test.com">
      </div>

      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" required value="TestPass123!">
      </div>

      <div class="form-group">
        <label for="role">Role:</label>
        <select id="role" required>
          <option value="patient">Patient</option>
          <option value="doctor">Doctor</option>
          <option value="technician">Technician</option>
          <option value="admin">Admin</option>
          <option value="hospital">Hospital</option>
          <option value="freelance-tech">Freelance Technician</option>
        </select>
      </div>

      <button type="submit" id="loginBtn">Test Login</button>
    </form>

    <div class="test-accounts">
      <h3>Test Accounts</h3>
      <ul>
        <li><strong>Patient:</strong> patient@test.com / TestPass123!</li>
        <li><strong>Doctor:</strong> doctor@test.com / TestPass123!</li>
        <li><strong>Technician:</strong> tech@test.com / TestPass123!</li>
        <li><strong>Admin:</strong> admin@test.com / Admin123!</li>
        <li><strong>Hospital:</strong> hospital@test.com / TestPass123!</li>
        <li><strong>Freelance:</strong> freelance@test.com / TestPass123!</li>
      </ul>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kwlommrclqhpvthqxcge.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3bG9tbXJjbHFocHZ0aHF4Y2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM0ODQzMjIsImV4cCI6MjA0OTA2MDMyMn0.CG4XBDG-wuH5LQp_yZSmbnUMBUQ_CqtaFrg4Cf-jqB4';

    const { createClient } = supabase;

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        storage: localStorage,
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false
      }
    });

    const roleMapping = {
      'patient': 'PATIENT',
      'doctor': 'DOCTOR',
      'technician': 'TECHNICIAN',
      'admin': 'ADMIN',
      'hospital': 'HOSPITAL_ADMIN',
      'freelance-tech': 'FREELANCE_TECHNICIAN'
    };

    const reverseRoleMapping = {
      'PATIENT': 'patient',
      'DOCTOR': 'doctor',
      'TECHNICIAN': 'technician',
      'ADMIN': 'admin',
      'HOSPITAL_ADMIN': 'hospital',
      'FREELANCE_TECHNICIAN': 'freelance-tech'
    };

    function showResult(type, title, message, details = null) {
      const resultDiv = document.getElementById('result');
      let html = `<div class="result ${type}">
        <strong>${title}</strong><br>${message}`;

      if (details) {
        html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
      }

      html += '</div>';
      resultDiv.innerHTML = html;
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      const loginBtn = document.getElementById('loginBtn');

      loginBtn.disabled = true;
      loginBtn.textContent = 'Testing...';
      showResult('info', 'Step 1/4', 'Attempting authentication...', null);

      try {
        const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
          email: email.toLowerCase(),
          password
        });

        if (authError) {
          showResult('error', 'Authentication Failed', authError.message, { code: authError.status });
          loginBtn.disabled = false;
          loginBtn.textContent = 'Test Login';
          return;
        }

        showResult('info', 'Step 2/4', 'Authentication successful! Checking session...', {
          user_id: authData.user.id,
          email: authData.user.email,
          session_exists: !!authData.session
        });

        await new Promise(resolve => setTimeout(resolve, 500));

        const { data: { session } } = await supabaseClient.auth.getSession();

        if (!session) {
          showResult('error', 'Session Error', 'Authentication succeeded but session not found in storage', null);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Test Login';
          return;
        }

        showResult('info', 'Step 3/4', 'Session retrieved! Fetching user data...', {
          access_token_length: session.access_token?.length || 0,
          token_stored: !!localStorage.getItem('supabase.auth.token')
        });

        await new Promise(resolve => setTimeout(resolve, 500));

        const { data: userData, error: userError } = await supabaseClient
          .from('users')
          .select('*, user_profiles(*)')
          .eq('id', authData.user.id)
          .maybeSingle();

        if (userError) {
          showResult('error', 'User Data Fetch Failed', userError.message, null);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Test Login';
          return;
        }

        showResult('info', 'Step 4/4', 'User data retrieved! Verifying role...', {
          database_role: userData.role,
          expected_role: roleMapping[role]
        });

        await new Promise(resolve => setTimeout(resolve, 500));

        const userRole = reverseRoleMapping[userData.role];

        if (userRole !== role) {
          await supabaseClient.auth.signOut();
          showResult('error', 'Role Mismatch', `This account is registered as a ${userRole}, not a ${role}`, {
            expected: role,
            actual: userRole
          });
          loginBtn.disabled = false;
          loginBtn.textContent = 'Test Login';
          return;
        }

        showResult('success', 'Login Successful!', 'All steps completed successfully', {
          user_id: userData.id,
          email: userData.email,
          role: userRole,
          name: userData.user_profiles?.fullName || 'Unknown',
          status: userData.status,
          session_persisted: !!localStorage.getItem('supabase.auth.token')
        });

      } catch (error) {
        showResult('error', 'Unexpected Error', error.message, null);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Test Login';
      }
    });

    window.addEventListener('load', async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        showResult('info', 'Existing Session Found', 'A user is already logged in. Click "Test Login" to test again or logout first.', {
          user_id: session.user.id,
          email: session.user.email
        });
      }
    });
  </script>
</body>
</html>
